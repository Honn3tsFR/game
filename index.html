<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Super 2D Multi</title>
<style>body{margin:0;overflow:hidden}canvas{background:#222;display:block}</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="scoreboard" style="position:absolute;top:10px;left:10px;color:white;font-family:monospace;"></div>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = 600;
canvas.height = 600;

const scoreboard = document.getElementById('scoreboard');

let ws=null;
let myId=null;
const players = {};
const bullets = [];
const keys = {};
const mouse = {x:0,y:0,down:false};
const local = {x:300,y:300,hp:100,color:'#56CCF2',lastShoot:0};

function connect(){
  ws=new WebSocket('wss://game-oywt.onrender.com'); // <--- Remplace par ton URL Render
  ws.onopen = ()=>console.log('Connected');
  ws.onmessage = e=>{
    const msg = JSON.parse(e.data);
    if(msg.t==='init'){ myId=msg.id; msg.players.forEach(p=>players[p.id]=p); bullets.push(...msg.bullets); }
    else if(msg.t==='state'){ msg.players.forEach(p=>players[p.id]=p); bullets.length=0; bullets.push(...msg.bullets); }
  };
}

function shoot(){
  if(Date.now()-local.lastShoot>200){
    local.lastShoot=Date.now();
    const dx = mouse.x - local.x;
    const dy = mouse.y - local.y;
    const angle = Math.atan2(dy,dx);
    if(ws && ws.readyState===WebSocket.OPEN)
      ws.send(JSON.stringify({t:'shoot', x:local.x, y:local.y, angle, color:local.color}));
  }
}

function update(){
  if(keys['w']) local.y -= 3;
  if(keys['s']) local.y += 3;
  if(keys['a']) local.x -= 3;
  if(keys['d']) local.x += 3;
  if(mouse.down) shoot();
  if(ws && ws.readyState===WebSocket.OPEN)
    ws.send(JSON.stringify({t:'update', x:local.x, y:local.y, hp:local.hp}));
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Draw bullets
  bullets.forEach(b=>{
    ctx.fillStyle=b.color;
    ctx.beginPath();
    ctx.arc(b.x,b.y,5,0,2*Math.PI);
    ctx.fill();
  });

  // Draw players
  for(const id in players){
    const p = players[id];
    ctx.fillStyle=p.color;
    ctx.beginPath();
    ctx.arc(p.x,p.y,10,0,2*Math.PI);
    ctx.fill();
  }

  // Draw local player on top
  ctx.fillStyle=local.color;
  ctx.beginPath();
  ctx.arc(local.x,local.y,10,0,2*Math.PI);
  ctx.fill();

  // Scoreboard
  const arr = Object.values(players).sort((a,b)=>b.score-a.score);
  scoreboard.innerHTML = arr.map(p=>p.id===myId?'YOU: '+p.score:'Player: '+p.score).join('<br>');
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}

window.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);
canvas.addEventListener('mousemove',e=>{ mouse.x=e.offsetX; mouse.y=e.offsetY; });
canvas.addEventListener('mousedown',()=>mouse.down=true);
canvas.addEventListener('mouseup',()=>mouse.down=false);

connect();
loop();
</script>
</body>
</html>
