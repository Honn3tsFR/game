<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mini Combat 3D Multi</title>
<style>body{margin:0;overflow:hidden}canvas{display:block}</style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script>
let scene=new THREE.Scene();
let camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
let renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(window.innerWidth,window.innerHeight);
document.body.appendChild(renderer.domElement);

let ws=null, myId=null;
const players={}, projectiles=[];
const local={x:0,y:0,z:0,angle:0,hp:100,color:'#56CCF2',lastShoot:0};
const keys={}, mouse={x:0,y:0,down:false};

let cubeMap={};
let sphereMap=[];

// Baseplate
let plane=new THREE.Mesh(new THREE.PlaneGeometry(50,50), new THREE.MeshPhongMaterial({color:0x228B22}));
plane.rotation.x=-Math.PI/2;
scene.add(plane);

// Light
let light=new THREE.DirectionalLight(0xffffff,1); light.position.set(5,10,5); scene.add(light);
scene.add(new THREE.AmbientLight(0x404040));

// Camera
camera.position.set(0,5,10);
camera.lookAt(0,0,0);

function connect(){
  ws=new WebSocket('wss://game-oywt.onrender.com'); // <--- Remplace par ton URL Render
  ws.onopen=()=>console.log('Connected');
  ws.onmessage=e=>{
    const msg=JSON.parse(e.data);
    if(msg.t==='init'){ myId=msg.id; msg.players.forEach(p=>players[p.id]=p); projectiles.push(...msg.projectiles); }
    else if(msg.t==='state'){ 
      msg.players.forEach(p=>players[p.id]=p); 
      projectiles.length=0; projectiles.push(...msg.projectiles);
    }
  };
}

function shoot(){
  if(Date.now()-local.lastShoot>300){
    local.lastShoot=Date.now();
    if(ws && ws.readyState===WebSocket.OPEN)
      ws.send(JSON.stringify({t:'shoot', x:local.x, y:local.y, z:local.z, angle:local.angle, color:local.color}));
  }
}

function updatePlayerObjects(){
  for(const id in players){
    if(!cubeMap[id]){
      let cube=new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshPhongMaterial({color:players[id].color}));
      scene.add(cube); cubeMap[id]=cube;
    }
    const p=players[id];
    cubeMap[id].position.set(p.x,p.y+0.5,p.z);
  }
}

function updateProjectiles(){
  while(sphereMap.length<projectiles.length){
    let sph=new THREE.Mesh(new THREE.SphereGeometry(0.2,8,8), new THREE.MeshPhongMaterial({color:0xff0000}));
    scene.add(sph); sphereMap.push(sph);
  }
  projectiles.forEach((proj,i)=>{
    if(sphereMap[i]){
      sphereMap[i].position.set(proj.x,proj.y+0.2,proj.z);
    }
  });
}

function gameStep(dt){
  let dx=0,dz=0;
  if(keys['w']) dz-=1;
  if(keys['s']) dz+=1;
  if(keys['a']) dx-=1;
  if(keys['d']) dx+=1;
  const len=Math.hypot(dx,dz); if(len>0){ dx/=len; dz/=len; }
  local.x+=dx*5*dt; local.z+=dz*5*dt;
  local.angle=Math.atan2(mouse.x, mouse.y);
  if(mouse.down) shoot();
  if(ws && ws.readyState===WebSocket.OPEN)
    ws.send(JSON.stringify({t:'update', x:local.x, y:0, z:local.z, angle:local.angle, hp:local.hp}));
}

window.addEventListener('keydown',e=>{ keys[e.key.toLowerCase()]=true; });
window.addEventListener('keyup',e=>{ keys[e.key.toLowerCase()]=false; });
window.addEventListener('mousemove',e=>{ mouse.x=e.clientX; mouse.y=e.clientY; });
window.addEventListener('mousedown',()=>{ mouse.down=true; });
window.addEventListener('mouseup',()=>{ mouse.down=false; });

function animate(now){
  requestAnimationFrame(animate);
  const dt=0.016;
  gameStep(dt);
  updatePlayerObjects();
  updateProjectiles();
  renderer.render(scene,camera);
}
animate();
connect();
</script>
</body>
</html>
