<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mini Combat INSANE Multi</title>
<style>
html,body{margin:0;height:100%;background:#0b1020;color:#e6eef8;font-family:Arial}
canvas{background:#071026;display:block;margin:0 auto;border-radius:8px}
#scoreboard{position:absolute;top:10px;right:10px;color:#fff;font-family:monospace;}
</style>
</head>
<body>
<canvas id="game" width="900" height="600"></canvas>
<div id="scoreboard"></div>
<script>
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
const scoreboard=document.getElementById('scoreboard');
let ws=null, myId=null;
const players={}, projectiles=[];
const local={x:100,y:100,angle:0,hp:100,color:'#56CCF2',lastShoot:0};
const keys={}, mouse={x:0,y:0,down:false};

function connect(){
  ws=new WebSocket('wss://mini-combat-server.onrender.com'); // <--- Remplace par ton URL Render
  ws.onopen=()=>console.log('Connected');
  ws.onmessage=e=>{
    const msg=JSON.parse(e.data);
    if(msg.t==='init'){ myId=msg.id; msg.players.forEach(p=>players[p.id]=p); projectiles.push(...msg.projectiles); }
    else if(msg.t==='state'){ msg.players.forEach(p=>players[p.id]=p); projectiles.length=0; projectiles.push(...msg.projectiles); }
  };
}

function shoot(){
  if(Date.now()-local.lastShoot>200){
    local.lastShoot=Date.now();
    if(ws && ws.readyState===WebSocket.OPEN)
      ws.send(JSON.stringify({t:'shoot', x:local.x, y:local.y, angle:local.angle, color:local.color}));
  }
}

function gameStep(dt){
  let dx=0, dy=0;
  if(keys['w']) dy-=1; if(keys['s']) dy+=1;
  if(keys['a']) dx-=1; if(keys['d']) dx+=1;
  const len=Math.hypot(dx,dy); if(len>0){ dx/=len; dy/=len; }
  local.x+=dx*220*dt; local.y+=dy*220*dt;
  local.x=Math.max(16, Math.min(canvas.width-16, local.x));
  local.y=Math.max(16, Math.min(canvas.height-16, local.y));
  local.angle=Math.atan2(mouse.y-local.y, mouse.x-local.x);
  if(mouse.down) shoot();
}

function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#071026'; ctx.fillRect(0,0,canvas.width,canvas.height);

  for(const id in players){
    const p=players[id];
    ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.angle);
    ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(0,0,14,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#111'; ctx.fillRect(14,-4,18,8); ctx.restore();
    ctx.fillStyle='#222'; ctx.fillRect(p.x-22,p.y-30,44,6);
    ctx.fillStyle=id===myId?'#2ecc71':'#e74c3c'; ctx.fillRect(p.x-22,p.y-30,44*(p.hp/100),6);
  }

  for(const proj of projectiles){
    ctx.save(); ctx.translate(proj.x,proj.y); ctx.rotate(proj.angle);
    ctx.fillStyle=proj.color; ctx.beginPath(); ctx.arc(0,0,6,0,Math.PI*2); ctx.fill(); ctx.restore();
  }

  // Scoreboard
  const sorted = Object.values(players).sort((a,b)=>b.score-a.score);
  scoreboard.innerHTML = sorted.map(p=>`${p.color===local.color?'YOU':'Player'}: ${p.score}`).join('<br>');
}

window.addEventListener('keydown',e=>{ keys[e.key.toLowerCase()]=true; });
window.addEventListener('keyup',e=>{ keys[e.key.toLowerCase()]=false; });
canvas.addEventListener('mousemove',e=>{ const r=canvas.getBoundingClientRect(); mouse.x=e.clientX-r.left; mouse.y=e.clientY-r.top; });
canvas.addEventListener('mousedown',()=>{ mouse.down=true; });
window.addEventListener('mouseup',()=>{ mouse.down=false; });

let last=performance.now();
function loop(now){ const dt=(now-last)/1000; last=now; gameStep(dt); render(); requestAnimationFrame(loop);}
requestAnimationFrame(loop);
connect();
</script>
</body>
</html>
